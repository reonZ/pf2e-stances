(()=>{"use strict";let e="",t="module";function f(...t){return`${e}.settings.${t.join(".")}`}function n(e){return e.getFlag("core","sourceId")}function m(...t){let[f,n]=t;return f=`${e}.${f}`,n?game.i18n.format(f,n):game.i18n.localize(f)}function a(t){const f=(...e)=>m(`${t}.${e[0]}`,e[1]);return Object.defineProperties(f,{warn:{value:(...e)=>function(...e){const[t,f,n]=e;s(t,"warning",f,n)}(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},info:{value:(...e)=>o(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},error:{value:(...e)=>c(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},has:{value:f=>function(t){return game.i18n.has(`${e}.${t}`,!1)}(`${t}.${f}`),enumerable:!1,configurable:!1},path:{value:f=>function(t){return`${e}.${t}`}(`${t}.${f}`),enumerable:!1,configurable:!1},template:{value:(e,{hash:t})=>f(e,t),enumerable:!1,configurable:!1}}),f}function s(e,t,f,n){const a="string"==typeof t?t:"info",s="object"==typeof t?t:"object"==typeof f?f:void 0,o="boolean"==typeof t?t:"boolean"==typeof f?f:n??!1;ui.notifications.notify(m(e,s),a,{permanent:o})}function o(...e){const[t,f,n]=e;s(t,"info",f,n)}function c(...e){const[t,f,n]=e;s(t,"error",f,n)}const i=[{feat:"Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"},{feat:"Compendium.pf2e.feats-srd.Item.tDWc2LQNl0Op1Auq",effect:"Compendium.pf2e.feat-effects.Item.PS17dsXkTdQmOv7w"},{feat:"Compendium.pf2e.feats-srd.Item.j1hhTLOq7o80XCyV",effect:"Compendium.pf2e.feat-effects.Item.6ctQFQfSZ6o1uyyZ",action:"Compendium.pf2e.actionspf2e.Item.SMF1hTWPHtmlS8Cd"},{feat:"Compendium.pf2e.feats-srd.Item.AkV4Jyllo6nlK2Sl",effect:"Compendium.pf2e.feat-effects.Item.CgxYa0lrLUjS2ZhI"},{feat:"Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN",replace:"Compendium.pf2e.feats-srd.Item.AkV4Jyllo6nlK2Sl"},{feat:"Compendium.pf2e.feats-srd.Item.bf7NCeKqDClaqhTR",effect:"Compendium.pf2e.feat-effects.Item.nwkYZs6YwXYAJ4ps"},{feat:"Compendium.pf2e.feats-srd.Item.1p5ErCp33nGOzEsk",effect:"Compendium.pf2e.feat-effects.Item.LxSev4GNKv26DbZw"},{feat:"Compendium.pf2e.feats-srd.Item.OEGhbRgW6wRbccns",effect:"Compendium.pf2e.feat-effects.Item.qBR3kqGCeKp3T2Be"},{feat:"Compendium.pf2e.feats-srd.Item.8sy3sHwOHS4ImwvJ",effect:"Compendium.pf2e.feat-effects.Item.qUowHpn79Dpt1hVn"},{feat:"Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",effect:"Compendium.pf2e.feat-effects.Item.KBEJVRrie2JTHWIK"},{feat:"Compendium.pf2e.feats-srd.Item.FYz5eQeTox9IDkSd",effect:"Compendium.pf2e.feat-effects.Item.KiuBRoMFxL2Npt51"},{feat:"Compendium.pf2e.feats-srd.Item.9VGmE7X4aK2W8YWj",effect:"Compendium.pf2e.feat-effects.Item.KiuBRoMFxL2Npt51"},{feat:"Compendium.pf2e.feats-srd.Item.6GN1zh3RcnZhrzxP",effect:"Compendium.pf2e.feat-effects.Item.GGebXpRPyONZB3eS"},{feat:"Compendium.pf2e.feats-srd.Item.80CEAB05TP5ki9iW",effect:"Compendium.pf2e.feat-effects.Item.GvqB4M8LrHpzYEvl"},{feat:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.RozqjLocahvQWERr"},{feat:"Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK",replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT"},{feat:"Compendium.pf2e.feats-srd.Item.rFaUJtB46scuAidY",effect:"Compendium.pf2e.feat-effects.Item.mark4VEQoynfYNBF"},{feat:"Compendium.pf2e.feats-srd.Item.YeyOqNFKaeuOTiJr",effect:"Compendium.pf2e.feat-effects.Item.zzC2qZwEKf4Ja3xD"},{feat:"Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",effect:"Compendium.pf2e.feat-effects.Item.kzEPq4aczYb6OD2h"},{feat:"Compendium.pf2e.feats-srd.Item.x9cYkB8DrUBBwqJd",effect:"Compendium.pf2e.feat-effects.Item.tPKXLtDJ3bzJcXlv"},{feat:"Compendium.pf2e.feats-srd.Item.Jwq5o13uZF3ooln1",effect:"Compendium.pf2e.feat-effects.Item.pkcr9w5x6bKzl3om"},{feat:"Compendium.pf2e.feats-srd.Item.ZghzLmYgeE19GqjP",effect:"Compendium.pf2e.feat-effects.Item.W8CKuADdbODpBh6O"},{feat:"Compendium.pf2e.feats-srd.Item.KMVXUgFArcftg1jQ",effect:"Compendium.pf2e.feat-effects.Item.6IsZQpwRJQWIzdGx"},{feat:"Compendium.pf2e.feats-srd.Item.rByA8NDI6ZtNgBeT",effect:"Compendium.pf2e.feat-effects.Item.NWOmJ6WJFheaGhho"},{feat:"Compendium.pf2e.feats-srd.Item.YG2RxXE9SMfwo6wP",effect:"Compendium.pf2e.feat-effects.Item.1dxD3xsTzak6GNj5"},{feat:"Compendium.pf2e.feats-srd.Item.ZL5UU9quCTvcWzfY",effect:"Compendium.pf2e.feat-effects.Item.gYpy9XBPScIlY93p"},{feat:"Compendium.pf2e.feats-srd.Item.RzhnxgiAopWILCvs",effect:"Compendium.pf2e.feat-effects.Item.l4QUaedYofnfXig0"},{feat:"Compendium.pf2e.feats-srd.Item.hPDerDCYmag3s0dP",effect:"Compendium.pf2e.feat-effects.Item.6EDoy3OSFZ4L3Vs7"},{feat:"Compendium.pf2e.feats-srd.Item.C3MgEkPNaIhTddbr",effect:"Compendium.pf2e.feat-effects.Item.vjvcccAwdkOLA1Fc"},{feat:"Compendium.pf2e.feats-srd.Item.Yl2wYv24v5kw95aS",effect:"Compendium.pf2e.feat-effects.Item.9HPxAKpP3WJmICBx"},{feat:"Compendium.pf2e.feats-srd.Item.Ziky4XVV7syXVbUg",effect:"Compendium.pf2e.feat-effects.Item.kDTiRg9vVOYNnTyr"},{feat:"Compendium.pf2e.feats-srd.Item.BtZJJClWCpc31Ven",effect:"Compendium.pf2e.feat-effects.Item.OeZ0E1oUKyGPxPy0"},{feat:"Compendium.pf2e.feats-srd.Item.rbiMK71SvGZGRLJ1",effect:"Compendium.pf2e.feat-effects.Item.Im5JBInybWFbHEYS"},{feat:"Compendium.pf2e.feats-srd.Item.knZUN4sYExIyRC4F",effect:"Compendium.pf2e.feat-effects.Item.QDQwHxNowRwzUx9R"},{feat:"Compendium.pf2e.feats-srd.Item.tRHjUCl0xqG97nok",effect:"Compendium.pf2e.feat-effects.Item.Unfl4QQURWaX2zfd"},{feat:"Compendium.pf2e.feats-srd.Item.RsNvCSrCN7czHC0G",effect:"Compendium.pf2e.feat-effects.Item.Unfl4QQURWaX2zfd"},{feat:"Compendium.pf2e.feats-srd.Item.O0POcPD2aELYTcIK",effect:"Compendium.pf2e.feat-effects.Item.YkiTA74FrUUu5IvI"},{feat:"Compendium.pf2e.feats-srd.Item.6cQSPqXoAO6oJl0i",effect:"Compendium.pf2e.feat-effects.Item.RXbfq6oqzVnW6xOV"},{feat:"Compendium.pf2e.feats-srd.Item.hT0pVPqFuiEsmRb8",effect:"Compendium.pf2e.feat-effects.Item.P80mwvCAEncR2snK"},{feat:"Compendium.pf2e.feats-srd.Item.UjEeHamC2C8JfgJz",effect:"Compendium.pf2e.feat-effects.Item.CQfkyJkRHw4IHWhv"},{feat:"Compendium.pf2e.feats-srd.Item.GuEdTz1VMEptQnOd",effect:"Compendium.pf2e.feat-effects.Item.rp1YauUSULuqW8rs"},{feat:"Compendium.pf2e.feats-srd.Item.7FRYyKXDKjGoANYj",effect:"Compendium.pf2e.feat-effects.Item.BCyGDKcplkJiSAKJ"},{feat:"Compendium.pf2e.feats-srd.Item.2tUdsoPEnW9yS8so",effect:"Compendium.pf2e.feat-effects.Item.PMHwCrnh9W4sMu5b"},{feat:"Compendium.pf2e.feats-srd.Item.VCjAlOvjNvFJOsG5",effect:"Compendium.pf2e.feat-effects.Item.pf9yvKNg6jZLrE30"},{feat:"Compendium.pf2e.feats-srd.Item.xjLbabfyQzBNT4y1",effect:"Compendium.pf2e.feat-effects.Item.3eHMqVx30JGiJqtM"},{feat:"Compendium.pf2e.feats-srd.Item.kTRGAST9J9ZxJZ4A",effect:"Compendium.pf2e.feat-effects.Item.3eHMqVx30JGiJqtM"},{feat:"Compendium.pf2e.feats-srd.Item.Tj79ePSD212EZjRM",effect:"Compendium.pf2e.feat-effects.Item.h45sUZFs5jhuQdCE"},{feat:"Compendium.pf2e.feats-srd.Item.IaiEZaA8erufMUCr",effect:"Compendium.pf2e.feat-effects.Item.JefXqvhzUeBArkAP"},{feat:"Compendium.pf2e.feats-srd.Item.wZZyasfIqwiJBQAQ",effect:"Compendium.pf2e.feat-effects.Item.q6UokHWSEcEYWmvh"},{feat:"Compendium.pf2e.feats-srd.Item.AN9jY1JVcU20Qdw6",effect:"Compendium.pf2e.feat-effects.Item.b2kWJuCPj1rDMdwz"}],p=new Map,d=new Set,r=new Set;function u(){return new Set(r)}function C(){p.clear(),d.clear(),r.clear();for(const e of i)p.set(e.feat,e),d.add(e.effect),r.add(e.action??e.feat);try{const t=("custom",game.settings.get(e,"custom")).trim();if(!t)return;const f=JSON.parse(t);for(const e of f)"object"!=typeof e||Array.isArray(e)||"string"!=typeof e.feat||e.feat.length<21||"string"!=typeof e.effect||e.feat.length<21||p.has(e.feat)||d.has(e.effect)||(p.set(e.feat,e),d.add(e.effect))}catch(e){c("settings.custom.error"),console.error(e)}}function I(e){const t=[],f=[],m=new Map,a=new Map;for(const t of e.itemTypes.action){const e=t.sourceId;e&&r.has(e)&&a.set(e,t.id)}for(const n of e.itemTypes.feat){const e=n.sourceId,m=e&&p.get(e);m&&(t.push(m),m.replace&&f.push(m.replace),a.has(e)||a.set(e,n.id))}for(const t of e.itemTypes.effect){const e=n(t);e&&d.has(e)&&m.set(e,t.id)}return t.filter((e=>!f.includes(e.feat))).map((e=>{const t=fromUuidSync(e.feat),f=fromUuidSync(e.effect),n=e.replace&&fromUuidSync(e.replace);if(!t||!f)return;const s=e.action??e.feat;return{name:n?n.name:t.name,img:f.img,actionID:a.get(s),effectID:m.get(e.effect)??"",actionUUID:s,effectUUID:e.effect}})).filter((e=>e))}function l(e){const t=[];for(const f of e.itemTypes.effect){const e=n(f);e&&d.has(e)&&t.push({uuid:e,id:f.id})}return t}async function g(e,t){const f=await fromUuid(t);if(f){const t=f.toObject();getProperty(t,"flags.core.sourceId")||setProperty(t,"flags.core.sourceId",f.uuid);const n=await e.createEmbeddedDocuments("Item",[t]);return n[0]?.toMessage(),!0}return!1}async function h(e,t){const f=l(e),n=f.findIndex((e=>e.uuid===t));let m=!1;if(n<0)m=!0;else if(f.length){const e=f.filter((e=>e.uuid!==t)).length,m=f.filter((e=>e.uuid===t)).length>1;(e||m)&&f.splice(n,1)}f.length&&await e.deleteEmbeddedDocuments("Item",f.map((e=>e.id))),m&&g(e,t)}const y=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"];async function b(e){if(!function(e,t,f){return function(e,t){return t?t.flatMap((t=>e.itemTypes[t])):e.items}(e,["feat"]).some(function(e){return Array.isArray(e)?t=>function(e,t){const f=n(e);return!!f&&t.includes(f)}(t,e):t=>n(t)===e}(t))}(e,y))return;if(l(e).length)return;const t=I(e);if(t.length)if(1===t.length){const f=t[0];await g(e,f.effectUUID)&&o("useStance",{stance:f.name})}else!function(e,t){const f=a("menu");let n=`<h3>${f("select")}</h3>`;for(let e=0;e<t.length;e++){const f=t[e];n+='<label style="height: 24px; display: block;">',n+=`<input type="radio" name="stance" value="${f.effectUUID}"`,0===e&&(n+=" checked"),n+=` style="margin-right: .5em;"> <span>${f.name}</span></label>`}n+='<div style="margin-bottom: .5em;"></div>',new Dialog({title:f("title"),content:n,buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:f("accept"),callback:t=>g(e,t.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:f("cancel")}}}).render(!0)}(e,t)}function w(e){for(const t of Object.values(ui.windows))t instanceof ActorSheet&&e===t.actor&&t.render()}function U(e){const t=k(e);if(t){if(game.user.isGM){const e=l(t).map((e=>e.id));e.length&&t.deleteEmbeddedDocuments("Item",e)}w(t)}}function k(e){const t=e.actor;return t&&!t.isToken&&t.isOfType("character")?t:void 0}!function(f,n=!1){e||(e="pf2e-stances"),t=n?"system":"module"}(),Hooks.once("setup",(()=>{!function(t){const n=t.name;t.scope=t.scope??"world",t.config=t.config??!1,t.config&&(t.name=f(n,"name"),t.hint=f(n,"hint")),Array.isArray(t.choices)&&(t.choices=t.choices.reduce(((e,t)=>(e[t]=f(n,"choices",t),e)),{})),game.settings.register(e,n,t)}({name:"custom",type:String,default:"",config:!0,onChange:C})})),Hooks.once("ready",(()=>{var t;C(),(t=e,game.modules.get(t)).api={getStances:I,getActionsUUIDS:u,toggleStance:h}})),Hooks.on("deleteCombatant",U),Hooks.on("createCombatant",(function(e){const t=k(e);t&&(!game.user.isGM&&t.isOwner&&b(t),w(t))})),Hooks.on("deleteCombat",(function(e){for(const t of e.combatants)U(t)})),Hooks.on("renderCharacterSheetPF2e",(async function(f,n){const a=f.actor;await async function(f,n){const a=I(f).sort(((e,t)=>e.name.localeCompare(t.name)));if(!a.length)return;const s=f.getActiveTokens(!0,!0).some((e=>e.inCombat)),o=n.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),c=o.find(".actions-options"),i=await renderTemplate(function(...f){return f=f.filter((e=>"string"==typeof e)),`${t}s/${e}/templates/${f.join("/")}`}("stances.hbs"),{stances:a,canUseStances:s&&!f.isDead,i18n:m});c.length?c.after(i):o.prepend(i)}(a,n),n.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",(e=>async function(e,t){const f=e.currentTarget,n=f.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!n)return;h(t,f.dataset.effectUuid)}(e,a)))}))})();
//# sourceMappingURL=main.js.map